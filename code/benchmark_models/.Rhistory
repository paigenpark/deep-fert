forecasted_results[[paste(i, j, sep = "_")]] <- df_forecasted_long
}
}
final_fitted_df <- bind_rows(fitted_results)
final_fitted_df <- final_fitted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
final_forecasted_df <- bind_rows(forecasted_results)
final_forecasted_df <- final_forecasted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
# uncomment to re-save prediction files
write.table(final_forecasted_df, "supp_data/hu_100_year_forecasts.csv",
sep = ",", col.names = FALSE,
row.names = FALSE)
print(glue("Iteration {iter} complete – saved to hu_forecast_{iter}.csv"))
}
# 100 year forecasts
# Define a vector of required packages
required_packages <- c("demography", "tidyverse", "glue", "here")
# Ensure user library directory exists
user_lib <- Sys.getenv("R_LIBS_USER")
if (!dir.exists(user_lib)) {
dir.create(user_lib, recursive = TRUE, showWarnings = FALSE)
}
# Function to check and install missing packages to user lib
install_if_missing <- function(pkg) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg, lib = user_lib)
}
}
# Apply the function to all required packages
invisible(lapply(required_packages, install_if_missing))
# Load the libraries
lapply(required_packages, library, character.only = TRUE)
path <- here("data")
country_training <- read.table(paste(path, "country_training.txt", sep = "/"), header = FALSE)
countries <- unique(country_training[,1])
genders <- unique(country_training[,2])
years <- unique(country_training[,3])
ages <- unique(country_training[,4])
forecasted_years <- 2006:2105
colnames(country_training) <- c('Country', 'Gender', 'Year', 'Age', 'Rate')
fitted_results <- list()
forecasted_results <- list()
for(iter in 1) {
set.seed(iter)
for (i in countries) {
for (j in genders) {
filtered <- country_training |>
filter(country_training[,1] == i & country_training[,2] == j)
# get number of years available for country/gender combo
years_i <- sort(unique(filtered$Year))
mx_df <- filtered |>
pivot_wider(names_from = 'Year',
values_from = 'Rate') |>
select(-Age, -Gender, -Country)
mx_mat <- as.matrix(mx_df)
#colnames(mx_mat) <- years
mx_mat[mx_mat == 0 | is.na(mx_mat)] <- 9e-06
Ext <- matrix(1, nrow = nrow(mx_mat), ncol = ncol(mx_mat))
data <- demogdata(
data = mx_mat,
pop = Ext,
ages = ages,
years = years_i,
type = "mortality",
label = i,
name = j
)
hu_output <- fdm(data,
series = j,
ages = ages,
years = years_i,
order = 3)
fitted <- exp(hu_output$fitted$y)
df_fitted <- as.data.frame(fitted)
df_fitted$age <- ages
df_fitted_long <- df_fitted |>
pivot_longer(cols = !age, names_to = "year", values_to = "rate")
#df_fitted_long$year <- rep(years_i, each = length(ages))
df_fitted_long$country <- i
df_fitted_long$gender <- j
fitted_results[[paste(i, j, sep = "_")]] <- df_fitted_long
forecasted <- forecast(hu_output, h=100)
forecasted_rates <- do.call(cbind, forecasted$rate[1])
df_forecasted <- as.data.frame(forecasted_rates)
df_forecasted$age <- ages
df_forecasted_long <- df_forecasted |>
pivot_longer(cols = !age, names_to = "year", values_to = "rate")
#df_forecasted_long$year <- rep(forecasted_years, each = length(ages))
df_forecasted_long$country <- i
df_forecasted_long$gender <- j
forecasted_results[[paste(i, j, sep = "_")]] <- df_forecasted_long
}
}
final_fitted_df <- bind_rows(fitted_results)
final_fitted_df <- final_fitted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
final_forecasted_df <- bind_rows(forecasted_results)
final_forecasted_df <- final_forecasted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
# uncomment to re-save prediction files
write.table(final_forecasted_df, "supp_data/hu_100_year_forecasts.csv",
sep = ",", col.names = FALSE,
row.names = FALSE)
print(glue("Iteration {iter} complete – saved to hu_forecast_{iter}.csv"))
}
# 100 year forecasts
# Define a vector of required packages
required_packages <- c("demography", "tidyverse", "glue", "here")
# Ensure user library directory exists
user_lib <- Sys.getenv("R_LIBS_USER")
if (!dir.exists(user_lib)) {
dir.create(user_lib, recursive = TRUE, showWarnings = FALSE)
}
# Function to check and install missing packages to user lib
install_if_missing <- function(pkg) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg, lib = user_lib)
}
}
# Apply the function to all required packages
invisible(lapply(required_packages, install_if_missing))
# Load the libraries
lapply(required_packages, library, character.only = TRUE)
path <- here("data")
country_training <- read.table(paste(path, "country_training.txt", sep = "/"), header = FALSE)
countries <- unique(country_training[,1])
genders <- unique(country_training[,2])
years <- unique(country_training[,3])
ages <- unique(country_training[,4])
forecasted_years <- 2006:2105
colnames(country_training) <- c('Country', 'Gender', 'Year', 'Age', 'Rate')
fitted_results <- list()
forecasted_results <- list()
for(iter in 1) {
set.seed(iter)
for (i in countries) {
for (j in genders) {
filtered <- country_training |>
filter(country_training[,1] == i & country_training[,2] == j)
# get number of years available for country/gender combo
years_i <- sort(unique(filtered$Year))
mx_df <- filtered |>
pivot_wider(names_from = 'Year',
values_from = 'Rate') |>
select(-Age, -Gender, -Country)
mx_mat <- as.matrix(mx_df)
#colnames(mx_mat) <- years
mx_mat[mx_mat == 0 | is.na(mx_mat)] <- 9e-06
Ext <- matrix(1, nrow = nrow(mx_mat), ncol = ncol(mx_mat))
data <- demogdata(
data = mx_mat,
pop = Ext,
ages = ages,
years = years_i,
type = "mortality",
label = i,
name = j
)
hu_output <- fdm(data,
series = j,
ages = ages,
years = years_i,
order = 3)
fitted <- exp(hu_output$fitted$y)
df_fitted <- as.data.frame(fitted)
df_fitted$age <- ages
df_fitted_long <- df_fitted |>
pivot_longer(cols = !age, names_to = "year", values_to = "rate")
#df_fitted_long$year <- rep(years_i, each = length(ages))
df_fitted_long$country <- i
df_fitted_long$gender <- j
fitted_results[[paste(i, j, sep = "_")]] <- df_fitted_long
forecasted <- forecast(hu_output, h=100)
forecasted_rates <- do.call(cbind, forecasted$rate[1])
df_forecasted <- as.data.frame(forecasted_rates)
df_forecasted$age <- ages
df_forecasted_long <- df_forecasted |>
pivot_longer(cols = !age, names_to = "year", values_to = "rate")
#df_forecasted_long$year <- rep(forecasted_years, each = length(ages))
df_forecasted_long$country <- i
df_forecasted_long$gender <- j
forecasted_results[[paste(i, j, sep = "_")]] <- df_forecasted_long
}
}
final_fitted_df <- bind_rows(fitted_results)
final_fitted_df <- final_fitted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
final_forecasted_df <- bind_rows(forecasted_results)
final_forecasted_df <- final_forecasted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
# uncomment to re-save prediction files
write.table(final_forecasted_df, "../supp_data/hu_100_year_forecasts.csv",
sep = ",", col.names = FALSE,
row.names = FALSE)
print(glue("Only iteration complete – saved to hu_100_year_forecasts.csv"))
}
getwd()
# 100 year forecasts
# Define a vector of required packages
required_packages <- c("demography", "tidyverse", "glue", "here")
# Ensure user library directory exists
user_lib <- Sys.getenv("R_LIBS_USER")
if (!dir.exists(user_lib)) {
dir.create(user_lib, recursive = TRUE, showWarnings = FALSE)
}
# Function to check and install missing packages to user lib
install_if_missing <- function(pkg) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg, lib = user_lib)
}
}
# Apply the function to all required packages
invisible(lapply(required_packages, install_if_missing))
# Load the libraries
lapply(required_packages, library, character.only = TRUE)
path <- here("data")
country_training <- read.table(paste(path, "country_training.txt", sep = "/"), header = FALSE)
countries <- unique(country_training[,1])
genders <- unique(country_training[,2])
years <- unique(country_training[,3])
ages <- unique(country_training[,4])
forecasted_years <- 2006:2105
colnames(country_training) <- c('Country', 'Gender', 'Year', 'Age', 'Rate')
fitted_results <- list()
forecasted_results <- list()
for(iter in 1) {
set.seed(iter)
for (i in countries) {
for (j in genders) {
filtered <- country_training |>
filter(country_training[,1] == i & country_training[,2] == j)
# get number of years available for country/gender combo
years_i <- sort(unique(filtered$Year))
mx_df <- filtered |>
pivot_wider(names_from = 'Year',
values_from = 'Rate') |>
select(-Age, -Gender, -Country)
mx_mat <- as.matrix(mx_df)
#colnames(mx_mat) <- years
mx_mat[mx_mat == 0 | is.na(mx_mat)] <- 9e-06
Ext <- matrix(1, nrow = nrow(mx_mat), ncol = ncol(mx_mat))
data <- demogdata(
data = mx_mat,
pop = Ext,
ages = ages,
years = years_i,
type = "mortality",
label = i,
name = j
)
hu_output <- fdm(data,
series = j,
ages = ages,
years = years_i,
order = 3)
fitted <- exp(hu_output$fitted$y)
df_fitted <- as.data.frame(fitted)
df_fitted$age <- ages
df_fitted_long <- df_fitted |>
pivot_longer(cols = !age, names_to = "year", values_to = "rate")
#df_fitted_long$year <- rep(years_i, each = length(ages))
df_fitted_long$country <- i
df_fitted_long$gender <- j
fitted_results[[paste(i, j, sep = "_")]] <- df_fitted_long
forecasted <- forecast(hu_output, h=100)
forecasted_rates <- do.call(cbind, forecasted$rate[1])
df_forecasted <- as.data.frame(forecasted_rates)
df_forecasted$age <- ages
df_forecasted_long <- df_forecasted |>
pivot_longer(cols = !age, names_to = "year", values_to = "rate")
#df_forecasted_long$year <- rep(forecasted_years, each = length(ages))
df_forecasted_long$country <- i
df_forecasted_long$gender <- j
forecasted_results[[paste(i, j, sep = "_")]] <- df_forecasted_long
}
}
final_fitted_df <- bind_rows(fitted_results)
final_fitted_df <- final_fitted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
final_forecasted_df <- bind_rows(forecasted_results)
final_forecasted_df <- final_forecasted_df |>
mutate(year = as.integer(year)) |>
select(country, gender, year, age, rate)
# uncomment to re-save prediction files
write.table(final_forecasted_df, "code/supplemental_figures/hu_100_year_forecasts.csv",
sep = ",", col.names = FALSE,
row.names = FALSE)
print(glue("Only iteration complete – saved to hu_100_year_forecasts.csv"))
}
# vector of required packages
required_packages <- c("demography", "tidyverse", "glue", "here")
# function to check and install missing packages
install_if_missing <- function(pkg) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg)
}
}
# apply the function to all required packages
invisible(lapply(required_packages, install_if_missing))
# load the libraries
lapply(required_packages, library, character.only = TRUE)
# load and prepare data
path <- here("data")
asfr_training <- read.table(paste(path, "asfr_training.txt", sep = "/"),
header = FALSE)
countries <- unique(asfr_training[,1])
ages <- unique(asfr_training[,3])
forecasted_years <- 2006:2015
colnames(asfr_training) <- c('Country', 'Year', 'Age', 'Rate')
fitted_results <- list()
forecasted_results <- list()
for (i in countries) {
filtered <- asfr_training |>
filter(Country == i)
ages <- sort(unique(filtered$Age))
years <- sort(unique(filtered$Year))
# get fx matrix
fx_df <- filtered |>
arrange(Age, Year) |> # Ensure sorting matches ages/years vectors
pivot_wider(names_from = 'Year',
values_from = 'Rate') |>
select(-Age, -Country)
fx_mat <- as.matrix(fx_df)
rownames(fx_mat) <- ages
colnames(fx_mat) <- years
fx_mat[fx_mat == 0 | is.na(fx_mat)] <- 1e-05
# get exposure matrix
Ext <- matrix(1, nrow = nrow(fx_mat), ncol = ncol(fx_mat))
# create demogdata object for lc function
data <- demogdata(
data = fx_mat,
pop = Ext,
ages = ages,
years = years,
type = "fertility",
label = i,
name = "female"
)
# run lc fitting function
lc_output <- lca(data,
years = years,
ages = ages,
adjust = 'none')
prep_results <- function(rates_mat, year_vector, country_id) {
df <- as.data.frame(rates_mat)
colnames(df) <- year_vector # Ensure columns are named by year
df$age <- ages
df_long <- df |>
pivot_longer(cols = -age, names_to = "year", values_to = "rate") |>
mutate(
year = as.numeric(year), # pivot_longer makes names strings
country = country_id
)
return(df_long)
}
# prep fitted results
fitted <- exp(lc_output$fitted$y)
fitted_results[[i]] <- prep_results(fitted, years, i)
# get/prep forecasts
forecasted <- forecast(lc_output, h=10)
forecasted_rates <- forecasted$rate$female
forecasted_results[[i]] <- prep_results(forecasted_rates, forecasted_years, i)
}
for (i in countries) {
filtered <- asfr_training |>
filter(Country == i)
ages <- sort(unique(filtered$Age))
years <- sort(unique(filtered$Year))
# get fx matrix
fx_df <- filtered |>
arrange(Age, Year) |> # Ensure sorting matches ages/years vectors
pivot_wider(names_from = 'Year',
values_from = 'Rate') |>
select(-Age, -Country)
fx_mat <- as.matrix(fx_df)
rownames(fx_mat) <- ages
colnames(fx_mat) <- years
fx_mat[fx_mat == 0 | is.na(fx_mat)] <- 1e-05
# get exposure matrix
Ext <- matrix(1, nrow = nrow(fx_mat), ncol = ncol(fx_mat))
# create demogdata object for lc function
data <- demogdata(
data = fx_mat,
pop = Ext,
ages = ages,
years = years,
type = "fertility",
label = i,
name = "female"
)
# run lc fitting function
lc_output <- lca(data,
years = years,
ages = ages,
adjust = 'none')
prep_results <- function(rates_mat, year_vector, country_id) {
df <- as.data.frame(rates_mat)
colnames(df) <- year_vector # Ensure columns are named by year
df$age <- ages
df_long <- df |>
pivot_longer(cols = -age, names_to = "year", values_to = "rate") |>
mutate(
year = as.numeric(year), # pivot_longer makes names strings
country = country_id
)
return(df_long)
}
# prep fitted results
fitted <- exp(lc_output$fitted$y)
fitted_results[[i]] <- prep_results(fitted, years, i)
# get/prep forecasts
forecasted <- forecast(lc_output, h=10)
forecasted_rates <- forecasted$rate$female
forecasted_results[[i]] <- prep_results(forecasted_rates, forecasted_years, i)
}
countries
forecasted_results[[i+1]] <- prep_results(forecasted_rates, forecasted_years, i)
##### Lee-Carter #####
##### Lee-Carter #####
# vector of required packages
required_packages <- c("demography", "tidyverse", "glue", "here")
# function to check and install missing packages
install_if_missing <- function(pkg) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg)
}
}
# apply the function to all required packages
invisible(lapply(required_packages, install_if_missing))
# load the libraries
lapply(required_packages, library, character.only = TRUE)
# load and prepare data
path <- here("data")
asfr_training <- read.table(paste(path, "asfr_training.txt", sep = "/"),
header = FALSE)
countries <- unique(asfr_training[,1])
ages <- unique(asfr_training[,3])
forecasted_years <- 2006:2015
colnames(asfr_training) <- c('Country', 'Year', 'Age', 'Rate')
fitted_results <- list()
forecasted_results <- list()
for (i in countries) {
filtered <- asfr_training |>
filter(Country == i)
ages <- sort(unique(filtered$Age))
years <- sort(unique(filtered$Year))
# get fx matrix
fx_df <- filtered |>
arrange(Age, Year) |> # Ensure sorting matches ages/years vectors
pivot_wider(names_from = 'Year',
values_from = 'Rate') |>
select(-Age, -Country)
fx_mat <- as.matrix(fx_df)
rownames(fx_mat) <- ages
colnames(fx_mat) <- years
fx_mat[fx_mat == 0 | is.na(fx_mat)] <- 1e-05
# get exposure matrix
Ext <- matrix(1, nrow = nrow(fx_mat), ncol = ncol(fx_mat))
# create demogdata object for lc function
data <- demogdata(
data = fx_mat,
pop = Ext,
ages = ages,
years = years,
type = "fertility",
label = i,
name = "female"
)
# run lc fitting function
lc_output <- lca(data,
years = years,
ages = ages,
adjust = 'none')
prep_results <- function(rates_mat, year_vector, country_id) {
df <- as.data.frame(rates_mat)
colnames(df) <- year_vector # Ensure columns are named by year
df$age <- ages
df_long <- df |>
pivot_longer(cols = -age, names_to = "year", values_to = "rate") |>
mutate(
year = as.numeric(year), # pivot_longer makes names strings
country = country_id
)
return(df_long)
}
# prep fitted results
fitted <- exp(lc_output$fitted$y)
fitted_results[[i+1]] <- prep_results(fitted, years, i)
# get/prep forecasts
forecasted <- forecast(lc_output, h=10)
forecasted_rates <- forecasted$rate$female
forecasted_results[[i+1]] <- prep_results(forecasted_rates, forecasted_years, i)
}
final_fitted_df <- bind_rows(fitted_results)
final_fitted_df <- final_fitted_df |>
select(country, year, age, rate)
final_forecasted_df <- bind_rows(forecasted_results)
final_forecasted_df <- final_forecasted_df |>
select(country, year, age, rate)
# save forecasts
write.table(final_forecasted_df, paste(path, "lc_forecast.csv", sep = "/"),
sep=",", col.names = FALSE,
row.names = FALSE)
print("Forecasts saved to lc_forecast.csv")
